{% extends 'components/base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .stat-card { background: white; border: 1px solid #e5e7eb; border-radius: .5rem; padding: 1.25rem; transition: transform .2s; }
  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .stat-icon { width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .filter-card { background: white; border: 1px solid #e5e7eb; border-radius: .5rem; padding: 1rem; margin-bottom: 1rem; }
  .table-container { background: white; border: 1px solid #e5e7eb; border-radius: .5rem; overflow: hidden; }
  .badge { display: inline-block; padding: .25rem .75rem; border-radius: 9999px; font-size: .75rem; font-weight: 500; }
  .badge-warning { background: #fef3c7; color: #92400e; }
  .badge-danger { background: #fee2e2; color: #991b1b; }
  .badge-success { background: #d1fae5; color: #065f46; }
  .badge-info { background: #dbeafe; color: #1e40af; }
  .alert-card { border-left: 4px solid; padding: 1rem; border-radius: .5rem; margin-bottom: 1rem; }
  .alert-warning { background: #fffbeb; border-color: #f59e0b; }
  .alert-danger { background: #fef2f2; border-color: #ef4444; }
  .alert-info { background: #eff6ff; border-color: #3b82f6; }
  .product-row { transition: all .2s; }
  .product-row:hover { background: #f9fafb; }
  .empty-state { text-align: center; padding: 3rem 1rem; }
  .empty-state-icon { font-size: 4rem; color: #d1d5db; margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <i class="fas fa-clock text-yellow-600"></i>
          {{ page_title|default:"Pending Products" }}
        </h1>
        <p class="text-sm text-gray-600 mt-1">
          {{ page_description|default:"Products waiting for vendor selection" }}
        </p>
      </div>
      <div class="flex gap-2">
        <a href="{% url 'farmer_product_add' %}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Add New Product
        </a>
        <a href="{% url 'farmer_products_all' %}" class="btn btn-secondary">
          <i class="fas fa-list"></i> All Products
        </a>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  {% if expired_count > 0 %}
  <div class="alert-card alert-danger">
    <div class="flex items-start gap-3">
      <i class="fas fa-exclamation-triangle text-red-600 mt-1"></i>
      <div class="flex-1">
        <h3 class="font-semibold text-red-900 mb-1">Expired Products Alert</h3>
        <p class="text-sm text-red-800">
          You have <strong>{{ expired_count }}</strong> expired product{{ expired_count|pluralize }} that need attention. 
          Consider removing or updating them.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  {% if expiring_soon_count > 0 %}
  <div class="alert-card alert-warning">
    <div class="flex items-start gap-3">
      <i class="fas fa-clock text-yellow-600 mt-1"></i>
      <div class="flex-1">
        <h3 class="font-semibold text-yellow-900 mb-1">Products Expiring Soon</h3>
        <p class="text-sm text-yellow-800">
          <strong>{{ expiring_soon_count }}</strong> product{{ expiring_soon_count|pluralize }} will expire within the next 7 days. 
          Make sure they are visible to vendors.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  {% if total_products == 0 %}
  <div class="alert-card alert-info">
    <div class="flex items-start gap-3">
      <i class="fas fa-info-circle text-blue-600 mt-1"></i>
      <div class="flex-1">
        <h3 class="font-semibold text-blue-900 mb-1">No Pending Products</h3>
        <p class="text-sm text-blue-800">
          You don't have any pending products. Add new products to make them available for vendor selection.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Pending Products -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Pending Products</p>
          <h3 class="text-2xl font-bold text-yellow-700">{{ total_products }}</h3>
          <p class="text-xs text-gray-500 mt-1">Awaiting selection</p>
        </div>
        <div class="stat-icon bg-yellow-100">
          <i class="fas fa-clock text-yellow-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Total Quantity -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Total Quantity</p>
          <h3 class="text-2xl font-bold text-blue-700">{{ total_quantity|floatformat:0 }} kg</h3>
          <p class="text-xs text-gray-500 mt-1">Ready for vendors</p>
        </div>
        <div class="stat-icon bg-blue-100">
          <i class="fas fa-weight text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Total Value -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Total Value</p>
          <h3 class="text-2xl font-bold text-green-700">Rs. {{ total_value|floatformat:0 }}</h3>
          <p class="text-xs text-gray-500 mt-1">Potential earnings</p>
        </div>
        <div class="stat-icon bg-green-100">
          <i class="fas fa-rupee-sign text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Expiring Soon -->
    <div class="stat-card">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Expiring Soon</p>
          <h3 class="text-2xl font-bold text-orange-700">{{ expiring_soon_count }}</h3>
          <p class="text-xs text-gray-500 mt-1">Within 7 days</p>
        </div>
        <div class="stat-icon bg-orange-100">
          <i class="fas fa-hourglass-half text-orange-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-card">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-filter text-blue-600"></i>
        Filters
      </h3>
      <button id="resetBtn" class="btn btn-secondary btn-sm">
        <i class="fas fa-redo"></i> Reset
      </button>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
      <!-- Product Name Search -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">
          <i class="fas fa-search"></i> Product Name
        </label>
        <input type="text" id="productFilter" class="form-control" placeholder="Search products...">
      </div>

      <!-- Category Filter -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">
          <i class="fas fa-tag"></i> Category
        </label>
        <select id="categoryFilter" class="form-control">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category.name }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Quality Filter -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">
          <i class="fas fa-star"></i> Quality Grade
        </label>
        <select id="qualityFilter" class="form-control">
          <option value="">All Grades</option>
          <option value="Grade A">Grade A - Premium</option>
          <option value="Grade B">Grade B - Standard</option>
          <option value="Grade C">Grade C - Economy</option>
        </select>
      </div>

      <!-- Expiry Status Filter -->
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">
          <i class="fas fa-calendar"></i> Expiry Status
        </label>
        <select id="expiryFilter" class="form-control">
          <option value="">All Products</option>
          <option value="expiring-soon">Expiring Soon (7 days)</option>
          <option value="expired">Expired</option>
          <option value="fresh">Fresh (30+ days)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <div class="overflow-x-auto">
      <table id="pendingProductsTable" class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Image</th>
            <th>Product</th>
            <th>Category</th>
            <th>Quality</th>
            <th>Quantity</th>
            <th>Price/kg</th>
            <th>Total Value</th>
            <th>Expiry Date</th>
            <th>Days Left</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          {% with days_until_expiry=product.expiry_date|timeuntil %}
          <tr class="product-row" 
              data-expiry-date="{{ product.expiry_date|date:'Y-m-d' }}"
              data-is-expired="{% if product.is_expired %}true{% else %}false{% endif %}">
            
            <!-- ID -->
            <td class="font-medium text-primary">#{{ product.id }}</td>
            
            <!-- Image -->
            <td>
              {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-12 h-12 object-cover rounded border">
              {% else %}
              <div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                <i class="fas fa-image text-gray-400"></i>
              </div>
              {% endif %}
            </td>
            
            <!-- Product Name -->
            <td>
              <div class="font-medium text-gray-800">{{ product.name }}</div>
              {% if product.description %}
              <div class="text-xs text-gray-500 max-w-xs truncate">{{ product.description|truncatewords:8 }}</div>
              {% endif %}
              {% if product.harvest_date %}
              <div class="text-xs text-gray-400 mt-1">
                <i class="fas fa-calendar"></i> Harvested: {{ product.harvest_date|date:"M d" }}
              </div>
              {% endif %}
            </td>
            
            <!-- Category -->
            <td>
              {% if product.category %}
              <span class="badge badge-info">
                <i class="fas fa-tag"></i> {{ product.category.name }}
              </span>
              {% else %}
              <span class="text-gray-400 text-sm">â€”</span>
              {% endif %}
            </td>
            
            <!-- Quality -->
            <td>
              <span class="badge {% if product.quality == 'A' %}badge-success{% elif product.quality == 'B' %}badge-info{% else %}badge-warning{% endif %}">
                Grade {{ product.quality }}
              </span>
            </td>
            
            <!-- Quantity -->
            <td class="text-center">
              <div class="font-semibold text-gray-800">{{ product.quantity|floatformat:0 }} kg</div>
              <div class="text-xs text-green-600">
                <i class="fas fa-check-circle"></i> All available
              </div>
            </td>
            
            <!-- Price per kg -->
            <td class="font-semibold text-primary">Rs. {{ product.base_price|floatformat:2 }}</td>
            
            <!-- Total Value -->
            <td class="font-bold text-green-700">
              Rs. {% widthratio product.base_price 1 product.quantity as value %}{{ value|floatformat:0 }}
            </td>
            
            <!-- Expiry Date -->
            <td>
              <div class="text-sm {% if product.is_expired %}text-red-600 font-semibold{% else %}text-gray-700{% endif %}">
                {{ product.expiry_date|date:"M d, Y" }}
              </div>
              {% if product.is_expired %}
              <div class="text-xs text-red-600 font-medium mt-1">
                <i class="fas fa-exclamation-triangle"></i> Expired
              </div>
              {% endif %}
            </td>
            
            <!-- Days Left -->
            <td>
              {% if product.is_expired %}
                <span class="badge badge-danger">
                  <i class="fas fa-times-circle"></i> Expired
                </span>
              {% else %}
                {% with product.expiry_date|timeuntil as time_left %}
                  {% if "day" in time_left %}
                    {% with time_left|cut:" days"|cut:" day" as days %}
                      {% if days|add:"0" <= 7 %}
                        <span class="badge badge-warning">
                          <i class="fas fa-exclamation-circle"></i> {{ time_left }}
                        </span>
                      {% else %}
                        <span class="badge badge-success">
                          <i class="fas fa-check-circle"></i> {{ time_left }}
                        </span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="badge badge-warning">
                      <i class="fas fa-clock"></i> {{ time_left }}
                    </span>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            
            <!-- Status -->
            <td>
              <span class="badge badge-warning">
                <i class="fas fa-clock"></i> Pending
              </span>
              <div class="text-xs text-gray-500 mt-1">
                Added {{ product.created_at|timesince }} ago
              </div>
            </td>
            
            <!-- Actions -->
            <td>
              <div class="flex gap-2">
                <a href="{% url 'farmer_product_detail' product.pk %}" 
                   class="btn btn-info btn-sm" 
                   title="View Details">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="{% url 'farmer_product_edit' product.pk %}" 
                   class="btn btn-warning btn-sm" 
                   title="Edit Product">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'farmer_product_delete' product.pk %}" 
                   class="btn btn-danger btn-sm" 
                   title="Delete Product"
                   onclick="return confirm('Are you sure you want to delete this product?')">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="12">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <i class="fas fa-box-open"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Pending Products</h3>
                <p class="text-gray-500 mb-4">
                  You don't have any products waiting for vendor selection.
                </p>
                <a href="{% url 'farmer_product_add' %}" class="btn btn-primary">
                  <i class="fas fa-plus"></i> Add Your First Product
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Info Box -->
  {% if total_products > 0 %}
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
      <div>
        <h4 class="font-semibold text-blue-900 mb-2">Tips for Getting Vendors to Select Your Products</h4>
        <ul class="text-sm text-blue-800 space-y-1">
          <li><i class="fas fa-check text-blue-600 mr-2"></i>Upload clear, high-quality product images</li>
          <li><i class="fas fa-check text-blue-600 mr-2"></i>Set competitive pricing based on market rates</li>
          <li><i class="fas fa-check text-blue-600 mr-2"></i>Provide detailed product descriptions</li>
          <li><i class="fas fa-check text-blue-600 mr-2"></i>Ensure your products have sufficient time before expiry</li>
          <li><i class="fas fa-check text-blue-600 mr-2"></i>Keep your product information up to date</li>
        </ul>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Initialize DataTable
  const table = $('#pendingProductsTable').DataTable({
    pageLength: 25,
    order: [[8, 'asc']], // Sort by expiry date (closest first)
    responsive: true,
    language: {
      emptyTable: "No pending products found",
      info: "Showing _START_ to _END_ of _TOTAL_ products",
      infoEmpty: "Showing 0 to 0 of 0 products",
      infoFiltered: "(filtered from _MAX_ total products)",
    },
    columnDefs: [
      { orderable: false, targets: [1, 11] } // Disable sorting for image and actions
    ],
    rowCallback: function(row, data, index) {
      const $row = $(row);
      const isExpired = $row.attr('data-is-expired') === 'true';
      const expiryDate = new Date($row.attr('data-expiry-date'));
      const today = new Date();
      const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
      
      // Add styling based on expiry status
      if (isExpired) {
        $row.addClass('bg-red-50 border-l-4 border-red-400');
      } else if (daysUntilExpiry <= 7) {
        $row.addClass('bg-yellow-50 border-l-4 border-yellow-400');
      } else {
        $row.addClass('border-l-4 border-green-400');
      }
    }
  });

  // Product name filter
  $('#productFilter').on('keyup', function() {
    table.column(2).search(this.value).draw();
  });

  // Category filter
  $('#categoryFilter').on('change', function() {
    table.column(3).search(this.value).draw();
  });

  // Quality filter
  $('#qualityFilter').on('change', function() {
    table.column(4).search(this.value).draw();
  });

  // Expiry status filter
  $('#expiryFilter').on('change', function() {
    const value = this.value;
    
    if (value === '') {
      // Show all
      $.fn.dataTable.ext.search.pop();
    } else {
      // Remove previous custom filter
      $.fn.dataTable.ext.search.pop();
      
      // Add custom filter
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const row = table.row(dataIndex).node();
        const $row = $(row);
        const isExpired = $row.attr('data-is-expired') === 'true';
        const expiryDate = new Date($row.attr('data-expiry-date'));
        const today = new Date();
        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        
        if (value === 'expired') {
          return isExpired;
        } else if (value === 'expiring-soon') {
          return !isExpired && daysUntilExpiry <= 7;
        } else if (value === 'fresh') {
          return !isExpired && daysUntilExpiry > 30;
        }
        
        return true;
      });
    }
    
    table.draw();
  });

  // Reset filters
  $('#resetBtn').on('click', function() {
    $('#productFilter').val('');
    $('#categoryFilter, #qualityFilter, #expiryFilter').val('');
    
    // Remove custom filters
    while ($.fn.dataTable.ext.search.length > 0) {
      $.fn.dataTable.ext.search.pop();
    }
    
    table.search('').columns().search('').draw();
  });

  // Highlight expiring soon products
  function highlightExpiringProducts() {
    $('.product-row').each(function() {
      const $row = $(this);
      const isExpired = $row.attr('data-is-expired') === 'true';
      const expiryDate = new Date($row.attr('data-expiry-date'));
      const today = new Date();
      const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
      
      if (isExpired) {
        $row.css('animation', 'pulse-red 2s infinite');
      } else if (daysUntilExpiry <= 3) {
        $row.css('animation', 'pulse-orange 2s infinite');
      }
    });
  }

  highlightExpiringProducts();

  // Add custom animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes pulse-red {
      0%, 100% { background-color: #fef2f2; }
      50% { background-color: #fee2e2; }
    }
    @keyframes pulse-orange {
      0%, 100% { background-color: #fffbeb; }
      50% { background-color: #fef3c7; }
    }
  `;
  document.head.appendChild(style);
});
</script>
{% endblock %}